(* ============================================
   КЕРУВАННЯ БОЙЛЕРОМ / ГАЗОВИМ ОБЛАДНАННЯМ
   Codesys 3.5 — Structured Text (ST)

   Як створити проект в Codesys:
   1. File → New Project → Standard Project
   2. Вибрати свій контролер або "CODESYS Control Win" для симуляції
   3. У дереві проекту: двічі клікнути PLC_PRG
   4. Вставити цей код
   5. Build → Build Solution (F11)
   6. Online → Login (Alt+F8) → Start (F5)
   ============================================ *)

PROGRAM PLC_PRG
VAR
    (* ==========================================
       АНАЛОГОВІ ВХОДИ (підключаються через
       Codesys I/O Mapping до реальних каналів)
       ========================================== *)
    AI_NAPRUGA      : INT;   (* Напруга бойлера, АЦП 0-4095 = 0-500В *)
    AI_TEMP_BOILER  : INT;   (* Температура бойлера, АЦП 0-4095 = 0-150°C *)
    AI_TEMP_VODA    : INT;   (* Температура води, АЦП 0-4095 = 0-150°C *)
    AI_TEMP_2       : INT;   (* Додатковий датчик температури *)
    AI_TISK_MASLA   : INT;   (* Тиск масла аналоговий, АЦП 0-4095 *)

    (* ==========================================
       ДИСКРЕТНІ ВХОДИ
       ========================================== *)
    X_GAZ           : BOOL;  (* Датчик газу: TRUE=є газ (замкнутий) *)
    X_VAKUUM        : BOOL;  (* Датчик вакууму: TRUE=є вакуум (замкнутий) *)
    X_TISK_MASLA_DI : BOOL;  (* Тиск масла: TRUE=норма (замкнутий) *)
    X_AVARIA_EXT    : BOOL;  (* Зовнішній аварійний СТОП *)

    (* ==========================================
       ДИСКРЕТНІ ВИХОДИ
       ========================================== *)
    Y_KLAPAN_GAZ    : BOOL;  (* Клапан газу: TRUE=відкрито *)
    Y_ROZET_1       : BOOL;  (* Розетка 1 *)
    Y_ROZET_2       : BOOL;  (* Розетка 2 *)
    Y_AVARIA_SIGNAL : BOOL;  (* Аварійна сигналізація (лампа/сирена) *)
    Y_DOZV_ROBOTY   : BOOL;  (* Загальний дозвіл роботи *)

    (* ==========================================
       КОМАНДИ ОПЕРАТОРА (з HMI або Visualization)
       ========================================== *)
    CMD_START       : BOOL;  (* Кнопка СТАРТ *)
    CMD_STOP        : BOOL;  (* Кнопка СТОП *)
    CMD_ROZET_1     : BOOL;  (* Команда увімкнути розетку 1 *)
    CMD_ROZET_2     : BOOL;  (* Команда увімкнути розетку 2 *)
    CMD_RESET_AVAR  : BOOL;  (* Скидання аварії вручну *)

    (* ==========================================
       ВНУТРІШНІ ЗМІННІ — АВАРІЇ
       ========================================== *)
    M_AVARIA_NAPRUGA    : BOOL;  (* Аварія: напруга >= 400В *)
    M_AVARIA_TEMP       : BOOL;  (* Аварія: температура бойлера >= 80°C *)
    M_AVARIA_VAKUUM     : BOOL;  (* Аварія: пропав вакуум *)
    M_ZAGALNA_AVARIA    : BOOL;  (* Загальна аварія (будь-яка з вище) *)

    (* ==========================================
       ВНУТРІШНІ ЗМІННІ — СТАНИ ДАТЧИКІВ
       ========================================== *)
    M_GAZ_IE            : BOOL;  (* Газ є = TRUE, немає = FALSE *)
    M_VAKUUM_IE         : BOOL;  (* Вакуум є = TRUE, немає = FALSE *)
    M_TISK_NORMA        : BOOL;  (* Тиск масла норма = TRUE *)

    (* ==========================================
       ВНУТРІШНІ ЗМІННІ — СИСТЕМА
       ========================================== *)
    M_SYSTEM_ON         : BOOL;  (* Система запущена оператором *)
    M_SYSTEM_READY      : BOOL;  (* Система готова до роботи *)

    (* ==========================================
       РЕАЛЬНІ ЗНАЧЕННЯ ДЛЯ ВІДОБРАЖЕННЯ НА HMI
       ========================================== *)
    NAPRUGA_VOLT        : INT;   (* Напруга в Вольтах *)
    TEMP_BOILER_GRAD    : INT;   (* Температура бойлера в °C *)
    TEMP_VODA_GRAD      : INT;   (* Температура води в °C *)
    TEMP_2_GRAD         : INT;   (* Температура доп. датчика в °C *)

    (* ==========================================
       ДОПОМІЖНІ ТРИГЕРИ (для кнопок START/STOP)
       ========================================== *)
    trig_START          : R_TRIG;  (* Фронт сигналу СТАРТ *)
    trig_STOP           : R_TRIG;  (* Фронт сигналу СТОП *)
    trig_RESET          : R_TRIG;  (* Фронт сигналу СКИДАННЯ *)
END_VAR

(* ============================================================
   БЛОК 1: ОБРОБКА КНОПОК СТАРТ / СТОП
   R_TRIG реагує тільки на момент натискання (фронт сигналу)
   ============================================================ *)
trig_START(CLK := CMD_START);
trig_STOP(CLK  := CMD_STOP);
trig_RESET(CLK := CMD_RESET_AVAR);

(* Запуск системи — тільки якщо немає аварії *)
IF trig_START.Q AND NOT M_ZAGALNA_AVARIA THEN
    M_SYSTEM_ON := TRUE;
END_IF;

(* Зупинка системи *)
IF trig_STOP.Q OR M_ZAGALNA_AVARIA THEN
    M_SYSTEM_ON := FALSE;
END_IF;

(* ============================================================
   БЛОК 2: ПЕРЕРАХУНОК АЦП → РЕАЛЬНІ ОДИНИЦІ

   Формула: РЕАЛЬНЕ = АЦП_ЗНАЧЕННЯ * МАКСИМУМ / 4095

   АЦП дає число від 0 до 4095 (12-бітний)
   Це число відповідає реальному вхідному сигналу 0-10В або 4-20мА
   ============================================================ *)

(* Напруга бойлера: вхід 0-10В = 0-500В реальних *)
NAPRUGA_VOLT     := INT_TO_INT(REAL_TO_INT(INT_TO_REAL(AI_NAPRUGA) * 500.0 / 4095.0));

(* Температура бойлера: вхід 4-20мА через модуль = 0-150°C *)
TEMP_BOILER_GRAD := INT_TO_INT(REAL_TO_INT(INT_TO_REAL(AI_TEMP_BOILER) * 150.0 / 4095.0));

(* Температура води *)
TEMP_VODA_GRAD   := INT_TO_INT(REAL_TO_INT(INT_TO_REAL(AI_TEMP_VODA) * 150.0 / 4095.0));

(* Додатковий датчик температури *)
TEMP_2_GRAD      := INT_TO_INT(REAL_TO_INT(INT_TO_REAL(AI_TEMP_2) * 150.0 / 4095.0));

(* ============================================================
   БЛОК 3: АВАРІЯ ПО НАПРУЗІ БОЙЛЕРА

   УМОВА: якщо напруга >= 400В → АВАРІЯ → все зупиняється
   ГІСТЕРЕЗИС: скидається тільки якщо впала нижче 380В
   (щоб уникнути постійного вмикання/вимикання на межі 400В)
   ============================================================ *)
IF NAPRUGA_VOLT >= 400 THEN
    M_AVARIA_NAPRUGA := TRUE;
ELSIF NAPRUGA_VOLT < 380 THEN
    (* Скидати аварію автоматично тільки якщо напруга впала *)
    (* Якщо хочеш скидати тільки вручну — закоментуй цей рядок *)
    IF trig_RESET.Q THEN
        M_AVARIA_NAPRUGA := FALSE;
    END_IF;
END_IF;

(* ============================================================
   БЛОК 4: АВАРІЯ ПО ТЕМПЕРАТУРІ БОЙЛЕРА

   УМОВА: якщо температура >= 80°C → АВАРІЯ → все зупиняється
   ГІСТЕРЕЗИС: скидається тільки якщо охолонув нижче 75°C
   ============================================================ *)
IF TEMP_BOILER_GRAD >= 80 THEN
    M_AVARIA_TEMP := TRUE;
ELSIF TEMP_BOILER_GRAD < 75 THEN
    IF trig_RESET.Q THEN
        M_AVARIA_TEMP := FALSE;
    END_IF;
END_IF;

(* ============================================================
   БЛОК 5: ДАТЧИК ГАЗУ

   X_GAZ = TRUE  (замкнутий контакт) → газ є   → M_GAZ_IE = 1
   X_GAZ = FALSE (розімкнутий)       → газу немає → M_GAZ_IE = 0

   На HMI відображати: якщо M_GAZ_IE=TRUE показуй "1 - ГАЗ Є"
                        якщо M_GAZ_IE=FALSE показуй "0 - ГАЗУ НЕМАЄ"
   ============================================================ *)
M_GAZ_IE := X_GAZ;

(* ============================================================
   БЛОК 6: ДАТЧИК ВАКУУМУ

   X_VAKUUM = TRUE  (замкнутий) → вакуум є   → робота дозволена
   X_VAKUUM = FALSE (розімкнутий) → вакууму немає → ЗУПИНКА + ЗАКРИТИ ГАЗ
   ============================================================ *)
M_VAKUUM_IE := X_VAKUUM;

IF NOT M_VAKUUM_IE THEN
    M_AVARIA_VAKUUM := TRUE;   (* Немає вакууму — АВАРІЯ *)
ELSE
    M_AVARIA_VAKUUM := FALSE;  (* Вакуум є — норма *)
END_IF;

(* ============================================================
   БЛОК 7: ДАТЧИК ТИСКУ МАСЛА

   X_TISK_MASLA_DI = TRUE  (замкнутий) → тиск норма
   X_TISK_MASLA_DI = FALSE (розімкнутий) → тиск низький → АВАРІЯ
   ============================================================ *)
M_TISK_NORMA := X_TISK_MASLA_DI;

(* ============================================================
   БЛОК 8: ЗАГАЛЬНА АВАРІЯ

   Якщо БУДЬ-ЯКА з умов виконана → загальна аварія
   → система зупиняється
   → клапан газу закривається
   → вмикається сигналізація
   ============================================================ *)
M_ZAGALNA_AVARIA := M_AVARIA_NAPRUGA    (* Напруга >= 400В *)
                 OR M_AVARIA_TEMP        (* Температура >= 80°C *)
                 OR M_AVARIA_VAKUUM      (* Немає вакууму *)
                 OR NOT M_TISK_NORMA     (* Тиск масла низький *)
                 OR X_AVARIA_EXT;        (* Зовнішній аварійний стоп *)

(* ============================================================
   БЛОК 9: ГОТОВНІСТЬ СИСТЕМИ ДО РОБОТИ

   ВСІ умови мають бути виконані одночасно:
   ✓ Напруга норма (< 400В)
   ✓ Температура норма (< 80°C)
   ✓ Газ є
   ✓ Вакуум є  ← НАЙВАЖЛИВІШЕ
   ✓ Тиск масла норма
   ✓ Немає зовнішньої аварії
   ✓ Оператор натиснув СТАРТ
   ============================================================ *)
M_SYSTEM_READY := NOT M_AVARIA_NAPRUGA
              AND NOT M_AVARIA_TEMP
              AND M_GAZ_IE
              AND M_VAKUUM_IE
              AND M_TISK_NORMA
              AND NOT X_AVARIA_EXT
              AND M_SYSTEM_ON;

(* ============================================================
   БЛОК 10: КЕРУВАННЯ КЛАПАНОМ ГАЗУ

   ВІДКРИТИ газ → тільки якщо система готова (всі умови ОК)
   ЗАКРИТИ газ → при будь-якій аварії, і особливо при відсутності вакууму

   БЕЗПЕКА: подвійна перевірка вакууму — навіть якщо
   щось пішло не так в логіці вище, газ все одно закриється
   ============================================================ *)
IF M_SYSTEM_READY THEN
    Y_KLAPAN_GAZ := TRUE;    (* Відкрити клапан газу *)
ELSE
    Y_KLAPAN_GAZ := FALSE;   (* Закрити клапан газу *)
END_IF;

(* КРИТИЧНА БЕЗПЕКА: подвійна гарантія закриття газу без вакууму *)
IF NOT M_VAKUUM_IE THEN
    Y_KLAPAN_GAZ := FALSE;   (* ОБОВ'ЯЗКОВО закрити! *)
END_IF;

(* КРИТИЧНА БЕЗПЕКА: закрити газ при аварії напруги або температури *)
IF M_AVARIA_NAPRUGA OR M_AVARIA_TEMP THEN
    Y_KLAPAN_GAZ := FALSE;
END_IF;

(* ============================================================
   БЛОК 11: КЕРУВАННЯ РОЗЕТКАМИ

   Розетки вмикаються командою оператора (з HMI або кнопки)
   АЛЕ тільки якщо немає загальної аварії
   ============================================================ *)
IF CMD_ROZET_1 AND NOT M_ZAGALNA_AVARIA THEN
    Y_ROZET_1 := TRUE;
ELSE
    Y_ROZET_1 := FALSE;
END_IF;

IF CMD_ROZET_2 AND NOT M_ZAGALNA_AVARIA THEN
    Y_ROZET_2 := TRUE;
ELSE
    Y_ROZET_2 := FALSE;
END_IF;

(* ============================================================
   БЛОК 12: АВАРІЙНА СИГНАЛІЗАЦІЯ
   Лампа або сирена вмикається при будь-якій аварії
   ============================================================ *)
Y_AVARIA_SIGNAL := M_ZAGALNA_AVARIA;

(* ============================================================
   БЛОК 13: ЗАГАЛЬНИЙ ДОЗВІЛ РОБОТИ
   Цей вихід можна підключити до загального контактора
   ============================================================ *)
Y_DOZV_ROBOTY := M_SYSTEM_READY;

END_PROGRAM